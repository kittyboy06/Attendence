import{u as z,a as T,r as l,s as f,j as e,L as V,B as F,R as K,b as I,A as P,c as U,d as W}from"./AttendanceView-Dzhb8Iah.js";const q=()=>{const h=z(),u=T(),[d,w]=l.useState(new Date().toISOString().split("T")[0]),[a,D]=l.useState([]),[v,j]=l.useState(!1),[g,n]=l.useState({}),[A,B]=l.useState(null);l.useEffect(()=>{_()},[]),l.useEffect(()=>{R()},[d]);const _=async()=>{const{data:t}=await f.from("students").select("id, name, register_no");if(t){const r={};t.forEach(i=>r[i.id]=i),n(r)}},R=async()=>{j(!0);const{data:t,error:r}=await f.from("attendance_logs").select(`
        *,
        subjects (name, code),
        teachers (name)
      `).eq("date",d);r&&console.error("Error fetching logs:",r),D(t||[]),j(!1)},L=()=>{if(a.length===0){alert("No logs to download.");return}let t=`Daily Attendance Report - ${d}
`;t+=`-------------------------------------------------------------------------------------------------------------------
`,t+=`| S.NO | SUBJECT               | TEACHER              | ABSENTEES (Reg No)           | OD (Reg No)                  | VERIFIED |
`,t+=`-------------------------------------------------------------------------------------------------------------------
`,a.forEach((s,b)=>{const M=(b+1).toString().padEnd(4),S=(s.subjects?.name.substring(0,20)||"Unknown").padEnd(21),O=(s.teachers?.name.substring(0,20)||"Unknown").padEnd(20),y=(s.absentees_json||[]).map(m=>g[m]?.register_no).filter(Boolean).join(", "),N=(s.od_students_json||[]).map(m=>g[m]?.register_no).filter(Boolean).join(", "),k=s.teacher_signature_url?"Signed":"Verified";t+=`| ${M} | ${S} | ${O} | ${y.padEnd(28)} | ${N.padEnd(28)} | ${k.padEnd(8)} |
`}),t+=`-------------------------------------------------------------------------------------------------------------------
`;const r=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(r),x=document.createElement("a");x.href=i,x.download=`Daily_Report_${d}.txt`,x.click(),URL.revokeObjectURL(i)};return e.jsxs("div",{className:"max-w-xl mx-auto p-4 pb-20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Attendance History"}),a.length>0&&e.jsx("button",{onClick:L,className:"bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition font-bold",children:"Download Report"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Date"}),e.jsx("input",{type:"date",value:d,onChange:t=>w(t.target.value),className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),v&&e.jsx(V,{}),!v&&a.length===0?e.jsx("div",{className:"text-center text-gray-500 py-10 bg-gray-50 rounded-lg",children:"No records found for this date."}):e.jsx("div",{className:"space-y-4",children:a.map(t=>{const r=A===t.id,i=(t.absentees_json||[]).map(s=>g[s]).filter(Boolean),x=(t.od_students_json||[]).map(s=>g[s]).filter(Boolean);return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow border border-gray-100 cursor-pointer",onClick:()=>B(r?null:t.id),children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800",children:t.subjects?.name||"Unknown Subject"}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.subjects?.code||"---"," • ",t.teachers?.name||"Unknown Teacher"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),h("/",{state:{editMode:!0,logData:t,from:u.pathname}})},className:"px-3 py-1 text-xs font-bold text-blue-600 bg-blue-50 rounded hover:bg-blue-100 border border-blue-200",children:"Edit"}),e.jsx("div",{className:`transform transition-transform ${r?"rotate-180":""} text-gray-400`,children:"▼"})]})]}),e.jsxs("div",{className:"mt-4 flex gap-4 text-sm",children:[e.jsxs("div",{className:"bg-red-50 text-red-700 px-2 py-1 rounded",children:["Absent: ",e.jsx("span",{className:"font-bold",children:(t.absentees_json||[]).length})]}),e.jsxs("div",{className:"bg-yellow-50 text-yellow-700 px-2 py-1 rounded",children:["OD: ",e.jsx("span",{className:"font-bold",children:(t.od_students_json||[]).length})]})]}),r&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 text-sm animate-fade-in",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"font-bold text-red-600 block mb-1",children:"Absentees:"}),i.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:i.map((s,b)=>e.jsxs("span",{className:"bg-red-50 text-red-700 px-2 py-0.5 rounded text-xs border border-red-100",children:[s.name," ",e.jsxs("span",{className:"opacity-75",children:["(",s.register_no,")"]})]},b))}):e.jsx("span",{className:"text-gray-400 italic",children:"None"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold text-yellow-600 block mb-1",children:"On Duty:"}),x.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:x.map((s,b)=>e.jsxs("span",{className:"bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded text-xs border border-yellow-100",children:[s.name," ",e.jsxs("span",{className:"opacity-75",children:["(",s.register_no,")"]})]},b))}):e.jsx("span",{className:"text-gray-400 italic",children:"None"})]})]})]},t.id)})})]})},Y=()=>{const[h,u]=l.useState(""),[d,w]=l.useState(!1),[a,D]=l.useState(null),[v,j]=l.useState(""),g=async()=>{if(h.trim()){w(!0),j(""),D(null);try{const{data:n,error:A}=await f.from("students").select("*").ilike("register_no",h.trim()).single();if(A||!n){j("Student not found with this Register Number."),w(!1);return}const{data:B}=await f.from("settings").select("*").eq("key","academic_start_date").maybeSingle(),{data:_}=await f.from("attendance_logs").select("*"),{data:R}=await f.from("holidays").select("date"),{data:L}=await f.from("special_schedules").select("date");if(!_)throw new Error("Data fetch error");const t=new Set(R?R.map(c=>c.date):[]),r=new Set(L?L.map(c=>c.date):[]),i=B?.value||"2000-01-01",[x,s,b]=i.split("-").map(Number),M=new Date(x,s-1,b),S=new Date;S.setHours(23,59,59,999);const O=new Date(n.created_at||"2000-01-01").toISOString().split("T")[0],y={};_.forEach(c=>{if(!c.date)return;const p=c.date.substring(0,10),E=String(c.period_number);y[p]||(y[p]={}),y[p][E]=c});let N=0,k=0,m=0,C=0,o=new Date(M);if(!(o>S))for(;o<=S;){if(o.getDay()!==0||r.has(o.toISOString().split("T")[0])){const p=o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")+"-"+String(o.getDate()).padStart(2,"0");if(t.has(p)){o.setDate(o.getDate()+1);continue}for(let E=1;E<=8;E++){if(N++,p<O){m++;continue}const $=y[p]?.[String(E)];$?$.absentees_json?.includes(n.id)?m++:$.od_students_json?.includes(n.id)?C++:k++:m++}}o.setDate(o.getDate()+1)}const H=N>0?((k+C)/N*100).toFixed(1):0;D({name:n.name,register_no:n.register_no,totalClasses:N,present:k+C,absent:m,od:C,percentage:H})}catch(n){console.error(n),j("Error fetching data.")}finally{w(!1)}}};return e.jsxs("div",{className:"flex flex-col h-full bg-gray-50 p-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-6 mt-2",children:"Student Portal"}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-600 mb-2",children:"Check Attendance"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Enter Register Number",className:"flex-1 border p-3 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-100 transition-all font-mono",value:h,onChange:n=>u(n.target.value),onKeyDown:n=>n.key==="Enter"&&g()}),e.jsx("button",{onClick:g,disabled:d,className:"bg-blue-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all",children:d?"...":"Go"})]}),v&&e.jsx("p",{className:"text-red-500 text-sm mt-3 animate-pulse",children:v})]}),a&&e.jsxs("div",{className:"bg-white rounded-3xl shadow-xl overflow-hidden animate-slide-up relative",children:[e.jsxs("div",{className:"bg-blue-600 p-6 text-white text-center relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-full bg-white/10 blur-3xl transform -translate-y-1/2"}),e.jsxs("h2",{className:"text-2xl font-bold relative z-10",children:[a.percentage,"%"]}),e.jsx("p",{className:"text-blue-100 text-sm relative z-10",children:"Overall Attendance"})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:a.name}),e.jsx("p",{className:"text-gray-400 text-sm",children:a.register_no})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-green-50 p-4 rounded-2xl border border-green-100 text-center",children:[e.jsx("span",{className:"block text-2xl font-bold text-green-600",children:a.present}),e.jsx("span",{className:"text-xs text-green-700 font-medium",children:"Present (inc. OD)"})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-2xl border border-red-100 text-center",children:[e.jsx("span",{className:"block text-2xl font-bold text-red-600",children:a.absent}),e.jsx("span",{className:"text-xs text-red-700 font-medium",children:"Absent"})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-2xl border border-yellow-100 text-center",children:[e.jsx("span",{className:"block text-2xl font-bold text-yellow-600",children:a.od}),e.jsx("span",{className:"text-xs text-yellow-700 font-medium",children:"On Duty"})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-2xl border border-gray-100 text-center",children:[e.jsx("span",{className:"block text-2xl font-bold text-gray-600",children:a.totalClasses}),e.jsx("span",{className:"text-xs text-gray-500 font-medium",children:"Total Classes"})]})]})]})]}),e.jsx("div",{className:"mt-auto text-center text-xs text-gray-300 pb-2",children:"Student Attendance System"})]})},G=()=>{const h=T(),u=d=>h.pathname===d;return e.jsxs("nav",{className:"w-full bg-white border-t border-gray-200 z-40 flex-none px-2 py-2 flex justify-around items-center",children:[e.jsxs(U,{to:"/",className:`flex flex-col items-center p-2 rounded-lg transition ${u("/")?"text-blue-600":"text-gray-400 hover:text-gray-600"}`,children:[e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),e.jsx("span",{className:"text-xs font-medium mt-1",children:"Mark"})]}),e.jsxs(U,{to:"/history",className:`flex flex-col items-center p-2 rounded-lg transition ${u("/history")?"text-blue-600":"text-gray-400 hover:text-gray-600"}`,children:[e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"text-xs font-medium mt-1",children:"History"})]}),e.jsxs(U,{to:"/student",className:`flex flex-col items-center p-2 rounded-lg transition ${u("/student")?"text-blue-600":"text-gray-400 hover:text-gray-600"}`,children:[e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"})}),e.jsx("span",{className:"text-xs font-medium mt-1",children:"Student"})]})]})};function J(){return e.jsx(F,{basename:"/Attendence/",children:e.jsx("div",{className:"fixed inset-0 w-full h-full bg-gray-100 font-sans text-gray-900 flex flex-col overflow-hidden sm:p-4",children:e.jsxs("div",{className:"flex-1 flex flex-col w-full h-full sm:max-w-md sm:mx-auto bg-white sm:rounded-xl sm:overflow-hidden shadow-xl relative",children:[e.jsx("div",{className:"flex-1 w-full overflow-hidden relative",children:e.jsxs(K,{children:[e.jsx(I,{path:"/",element:e.jsx(P,{})}),e.jsx(I,{path:"/history",element:e.jsx(q,{})}),e.jsx(I,{path:"/student",element:e.jsx(Y,{})})]})}),e.jsx(G,{})]})})})}W.createRoot(document.getElementById("root")).render(e.jsx(l.StrictMode,{children:e.jsx(J,{})}));
